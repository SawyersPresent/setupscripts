#!/usr/bin/python3
# filepath: certiparse

import json
import sys

# how wide to allow certain columns before truncating
TRUNCATE = {
    "Enrollment Rights": 40,
    "[!] Vulnerabilities": 30,
    "[*] Remarks": 50
}

# rights to exclude
EXCLUDE_RIGHTS = [
    "Enterprise Read-only Domain Controllers",
    "Domain Admins",
    "Domain Controllers",
    "Enterprise Admins",
    "Enterprise Domain Controllers",
]

def load_json(path):
    with open(path) as f:
        return json.load(f)

def fmt_list(lst):
    return ", ".join(lst) if isinstance(lst, list) else str(lst)

def fmt_keys(d):
    if not isinstance(d, dict) or not d:
        return ""
    return "; ".join(d.keys())

def truncate(s, max_len):
    return s if len(s) <= max_len else s[: max_len - 3] + "..."

def main(json_path):
    data = load_json(json_path)
    templates = data.get("Certificate Templates", {})
    cas = data.get("Certificate Authorities", {})

    headers = [
        "Template Name",
        "Client Authentication",
        "Any Purpose",
        "Enrollee Supplies Subject",
        "Enrollment Rights",
        "[!] Vulnerabilities",
        "[*] Remarks"
    ]

    # Check for CA vulnerabilities first
    ca_vulns = []
    for ca in cas.values():
        ca_vulns_dict = ca.get("[!] Vulnerabilities", {})
        if ca_vulns_dict:
            ca_vulns.extend(ca_vulns_dict.keys())
    
    if ca_vulns:
        print(" ")
        print("Certificate Authority Vulnerabilities")
        print("--------------------------------------")
        print(f"[!] Vulnerabilities {', '.join(ca_vulns)}")
        print()
        print()

    # build & filter rows
    raw_rows = []
    for tpl in templates.values():
        orig = tpl.get("Permissions", {}) \
                 .get("Enrollment Permissions", {}) \
                 .get("Enrollment Rights", [])
        filtered = [r for r in orig if not any(exc in r for exc in EXCLUDE_RIGHTS)]
        if not filtered:
            continue

        raw_rows.append({
            "Template Name":                tpl.get("Template Name", ""),
            "Client Authentication":        str(tpl.get("Client Authentication", "")),
            "Any Purpose":                  str(tpl.get("Any Purpose", "")),
            "Enrollee Supplies Subject":    str(tpl.get("Enrollee Supplies Subject", "")),
            "Enrollment Rights":            fmt_list(filtered),
            "[!] Vulnerabilities":          fmt_keys(tpl.get("[!] Vulnerabilities", {})),
            "[*] Remarks":                  fmt_keys(tpl.get("[*] Remarks", {})),
        })

    # truncate long cells & compute widths
    widths = {h: len(h) for h in headers}
    rows = []
    for row in raw_rows:
        nr = {}
        for h in headers:
            val = row[h]
            # if h in TRUNCATE:
            #     val = truncate(val, TRUNCATE[h])
            nr[h] = val
            widths[h] = max(widths[h], len(val))
        rows.append(nr)

    # build format string
    fmt = "  ".join(f"{{:<{widths[h]}}}" for h in headers)

    # print table
    print(fmt.format(*headers))
    print("  ".join("-" * widths[h] for h in headers))
    for r in rows:
        print(fmt.format(*(r[h] for h in headers)))

def show_help():
    print("certiparse - Parse Certipy JSON output")
    print()
    print("Usage:")
    print("  certiparse <certipy_output.json>")
    print("  certiparse --help")
    print()
    print("Description:")
    print("  Parses Certipy JSON output and displays certificate templates")
    print("  with enrollment rights and vulnerabilities in table format")
    print()
    print("Example:")
    print("  certipy find -target dc.test.local -output json")
    print("  certiparse certipy_output.json")

if __name__ == "__main__":
    if len(sys.argv) != 2 or sys.argv[1] in ['-h', '--help']:
        show_help()
        sys.exit(0)
    
    try:
        main(sys.argv[1])
    except Exception as e:
        print(f"Error: {e}")
        sys.exit(1)
